name: Cleanup old workflow runs

on:
  workflow_dispatch:   # 手动触发
  schedule:
    - cron: "0 1 * * 0"   # 每天周日1点执行一次

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            // 列出仓库所有 workflow
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            for (const wf of workflows.data.workflows) {
              // 获取每个 workflow 的运行记录
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: wf.id,
                per_page: 100
              });

              // 保留最新一次，删除其他
              const oldRuns = runs.data.workflow_runs.slice(1);
              for (const run of oldRuns) {
                console.log(`Deleting run ${run.id} of workflow ${wf.name}`);
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
              }
            }
